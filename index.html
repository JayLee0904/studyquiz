<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>StudyQuiz – 호환성 고정 버전</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f6f8fc;--card:#fff;--ink:#0f172a;--muted:#6b7280;--border:#e5e7eb;--primary:#2962FF;--ok:#1B8E3E;--ng:#D32F2F}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
.sidebar{position:fixed;left:0;top:0;bottom:0;width:320px;background:#fff;border-right:1px solid var(--border);padding:24px 20px}
.brand{font-weight:700;display:flex;gap:8px;align-items:center}
.btn{margin-top:12px;height:44px;width:100%;border:1px solid var(--border);border-radius:12px;background:#fff;font-weight:600;cursor:pointer}
.btn:hover{background:#f4f6ff}
.main{margin-left:320px;min-height:100vh;padding:32px;display:flex;justify-content:center}
#app{width:100%;max-width:920px}
.card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.progress{color:var(--muted)}
.image{width:100%;height:420px;object-fit:contain;background:#f7f9fc;border:1px solid #eef2f7;border-radius:12px}
.img-hint{display:none;margin:8px 0 12px;color:#9ca3af;font-size:12px}
.jp{font-size:22px;line-height:1.6;margin:12px 0 6px}
.kr{color:var(--muted);white-space:pre-wrap;margin:0 0 16px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.choice{border:1px solid var(--border);border-radius:12px;background:#f9fafb;padding:12px 14px;text-align:center;cursor:pointer}
.choice:hover{background:#f1f5ff}
.choice.correct{border:1px solid var(--ok);background:#eaf7ef}
.choice.wrong{border:1px solid var(--ng);background:#ffebee}
.controls{margin-top:16px;display:flex;gap:12px;flex-wrap:wrap}
.button{height:44px;padding:0 16px;border-radius:10px;border:1px solid var(--border);background:#fff;font-weight:600;cursor:pointer}
.button:not(.next):hover{background:#f1f5ff}
.next{background:var(--primary);border-color:var(--primary);color:#fff}
.next:hover{background:#1f4fe0}
.divider{height:1px;background:#e5e7eb;margin:20px 0}
.small{font-size:12px;color:var(--muted)}
pre.code{white-space:pre-wrap;background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:10px}
@media (max-width:980px){.sidebar{position:relative;width:auto;min-height:auto}.main{margin:0;padding:16px}.grid{grid-template-columns:1fr}}
.badge{display:inline-block;padding:2px 6px;border-radius:8px;background:#eef2ff;border:1px solid #c7d2fe;font-size:12px;color:#334155;margin-left:8px}

/* Feedback styles */
.feedback{margin-top:16px}
.fb-head{display:flex;align-items:center;gap:8px;font-weight:700;font-size:18px;margin-bottom:10px}
.fb-head.ok{color:#1B8E3E}
.fb-head.ng{color:#D32F2F}
.fb-body{background:#EEF5FF;border-radius:12px;padding:16px}


/* Intro hero */
.card.intro{ text-align:center; padding:40px 24px }
.card.intro .hero{ width:480px; height:382px; display:block; margin:0 auto 16px; }
.card.intro .title{ font-size:24px; margin:4px 0 8px }
.card.intro .subtitle{ color:var(--muted); margin:0 }

.card.intro .controls{ justify-content:center } 
.card.complete .hero{ width:480px; height:382px; display:block; margin:0 auto 16px; } 


/* Brand logo */
.brand{padding:4px 0 12px; justify-content:flex-start }
.brand-btn{border:none;background:transparent;padding:0;margin:0;cursor:pointer}
.brand-btn:focus{outline:none}
.brand img{display:block; height:30px; width:auto; max-width:180px}


/* Sidebar widgets */
.widgets{margin-top:16px; display:flex; flex-direction:column; gap:12px}
.wcard{border:1px solid var(--border); background:#fff; border-radius:12px; padding:12px}
.wtitle{font-weight:700; font-size:14px; color:#334155; margin:0 0 6px}
.wbody{font-size:14px; color:#0f172a}


/* ==== Material-based Dark Mode & Contrast Tweaks ==== */
:root{
  --primary:#2962FF;           /* MD3 Primary */
  --on-primary:#FFFFFF;
  --bg:#F6F8FC;                /* Surface */
  --on-bg:#0F172A;
  --surface:#FFFFFF;
  --surface-2:#F3F4F6;
  --outline:#E5E7EB;
  --muted:#6B7280;
  --ok:#1B8E3E;
  --on-ok:#FFFFFF;
  --ng:#D32F2F;
  --on-ng:#FFFFFF;
  --link:#0B57D0;
  --visited:#5E35B1;
  --shadow:0 10px 30px rgba(0,0,0,.06);
}
:root[data-theme="dark"]{
  --primary:#8AB4FF;           /* Lightened primary for dark */
  --on-primary:#0B1220;
  --bg:#0B1220;
  --on-bg:#E5E7EB;
  --surface:#0F172A;           /* surface-1 */
  --surface-2:#101826;         /* slightly brighter for cards */
  --outline:#21304A;           /* outline on dark */
  --muted:#94A3B8;
  --ok:#34D399;                /* emerald 400 for dark contrast */
  --on-ok:#0B1220;
  --ng:#FB7185;                /* rose 400 */
  --on-ng:#0B1220;
  --link:#8AB4FF;
  --visited:#C084FC;
  --shadow:0 14px 40px rgba(0,0,0,.45);
}
body{ background:var(--bg); color:var(--on-bg); }
.sidebar{ background:var(--surface); border-right:1px solid var(--outline); }
.card, .wcard{ background:var(--surface); border:1px solid var(--outline); box-shadow:var(--shadow); }
.btn, .control-btn, .choice{
  background:var(--surface); color:var(--on-bg); border:1px solid var(--outline);
}
.btn:hover, .control-btn:hover{ background:rgba(41,98,255,0.06); }
.choice:hover{ background:rgba(41,98,255,0.06); }
.choice.correct{ background:color-mix(in oklab, var(--ok) 20%, transparent); border-color:var(--ok); color:var(--on-bg); }
.choice.wrong{ background:color-mix(in oklab, var(--ng) 22%, transparent); border-color:var(--ng); color:var(--on-bg); }
a{ color:var(--link); }
a:visited{ color:var(--visited); }
.image{ background:color-mix(in srgb, var(--surface) 90%, black 10%); border-color:var(--outline); }

/* Focus rings - visible on both themes */
:where(.btn,.control-btn,.choice,.theme-toggle):focus{ outline:3px solid var(--primary); outline-offset:2px; }

/* Responsive grid for Day buttons */
.btn-group, #autoBtnGroup{
  display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:8px;
}

/* ==== Circular Theme Toggle Button (sun/moon) ==== */
.theme-toggle{
  --size:44px;
  inline-size:var(--size); block-size:var(--size);
  border-radius:999px;
  border:2px solid var(--outline);
  position:relative;
  background:
    radial-gradient(120% 120% at 30% 30%, rgba(255,255,255,.16), rgba(0,0,0,0)) ,
    var(--surface);
  box-shadow: inset 0 0 0 2px rgba(255,255,255,.06);
  cursor:pointer;
}
:root[data-theme="dark"] .theme-toggle{
  background:
    radial-gradient(120% 120% at 70% 70%, rgba(0,0,0,.35), rgba(255,255,255,0)) ,
    var(--surface-2);
}
.theme-toggle::before{
  /* icon container */
  content:"";
  position:absolute; inset:0;
  display:block;
  mask-size:60%; mask-position:center; mask-repeat:no-repeat;
  -webkit-mask-size:60%; -webkit-mask-position:center; -webkit-mask-repeat:no-repeat;
  background:var(--on-bg);
  /* default: sun */
  mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 24 24"><path fill="%23000" d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.79zm10.48 0l1.79-1.79l1.79 1.79l-1.79 1.79zM12 4V1h0v3zm0 19v-3h0v3zM4 12H1v0h3zm19 0h-3v0h3zM6.76 19.16l-1.8 1.8l-1.79-1.8l1.8-1.79zM19.16 17.37l1.79 1.79l-1.79 1.8l-1.8-1.8zM12 6a6 6 0 100 12a6 6 0 000-12z"/></svg>');
  -webkit-mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 24 24"><path fill="%23000" d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.79zm10.48 0l1.79-1.79l1.79 1.79l-1.79 1.79zM12 4V1h0v3zm0 19v-3h0v3zM4 12H1v0h3zm19 0h-3v0h3zM6.76 19.16l-1.8 1.8l-1.79-1.8l1.8-1.79zM19.16 17.37l1.79 1.79l-1.79 1.8l-1.8-1.8zM12 6a6 6 0 100 12a6 6 0 000-12z"/></svg>');
}
:root[data-theme="dark"] .theme-toggle::before{
  /* moon icon */
  mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 24 24"><path fill="%23000" d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"/></svg>');
  -webkit-mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 24 24"><path fill="%23000" d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"/></svg>');
}

/* Icon contrast inside button */
:root[data-theme="dark"] .theme-toggle::before{ background:#D1D5DB; }
/* Ring contrast */
.theme-toggle{ outline-offset:3px; }

/* Minor spacing for small screens */
@media (max-width:480px){
  .sidebar{ padding:16px 14px; }
  .main{ padding:16px; }
}


/* Feedback colors and surfaces */
.fb-head.ok{ color: var(--ok) !important; }
.fb-head.ng{ color: var(--ng) !important; }
:root[data-theme="dark"] .fb-body{
  background: color-mix(in oklab, var(--surface) 85%, var(--ok) 0%);
  border:1px solid var(--outline);
  color: var(--on-bg);
}
/* Progress card subtle contrast */
:root[data-theme="dark"] #widProgress{ color: var(--on-bg); opacity: .9; }
:root[data-theme="dark"] .wtitle{ color: color-mix(in oklab, var(--on-bg) 86%, transparent); }
/* Remove default blue focus ring */
.btn:focus, .control-btn:focus, .choice:focus, .theme-toggle:focus{ outline: none !important; }


/* Divider color per theme */
.divider{height:1px;border:0;background:var(--outline);opacity:.9}
:root[data-theme="dark"] .divider{background:#1f2a44;opacity:1}
:root[data-theme="dark"] .card, :root[data-theme="dark"] .wcard{ background:var(--surface-2); }

/* ==== Dark tone adjustment (charcoal + MD3 purple) ==== */
:root[data-theme="dark"]{
  --bg:#121215;            /* charcoal */
  --on-bg:#E6E7EA;
  --surface:#18181B;       /* surface-1 */
  --surface-2:#1F2024;     /* cards */
  --outline:#2C2D33;
  --muted:#A1A1AA;
  --primary:#A78BFA;       /* violet 400 */
  --on-primary:#0E0E11;
  --primary-press:#8B5CF6; /* violet 500 */
  --link:#B8A5FF;
  --visited:#D3B9FF;
}

/* Buttons — base (sidebar & generic) */
:root[data-theme="dark"] .btn,
:root[data-theme="dark"] .control-btn{
  background: var(--surface);
  border:1px solid var(--outline);
  color: var(--on-bg);
}
:root[data-theme="dark"] .btn:hover,
:root[data-theme="dark"] .control-btn:hover{
  background: #232329;
}

/* Primary action: Next */
:root[data-theme="dark"] #btnNext{
  background: var(--primary);
  color: #ffffff;
  border:1px solid color-mix(in oklab, var(--primary) 70%, black);
}
:root[data-theme="dark"] #btnNext:hover{
  background: var(--primary-press);
}

/* Secondary tonal: Listen / Prev / Reveal */
:root[data-theme="dark"] #btnPrev,
:root[data-theme="dark"] #btnReveal,
:root[data-theme="dark"] #btnShuffle,
:root[data-theme="dark"] #btnReset,
:root[data-theme="dark"] #btnSample,
:root[data-theme="dark"] #btnSpeak{
  background: #2A2336; /* primary-container-like */
  color: #EDE9FE;
  border-color: #3A3350;
}
:root[data-theme="dark"] #btnPrev:hover,
:root[data-theme="dark"] #btnReveal:hover,
:root[data-theme="dark"] #btnShuffle:hover,
:root[data-theme="dark"] #btnReset:hover,
:root[data-theme="dark"] #btnSample:hover,
:root[data-theme="dark"] #btnSpeak:hover{
  background: #332A47;
}

/* Choices remain subtle with state layers */
:root[data-theme="dark"] .choice:hover{ background:#232329; }
:root[data-theme="dark"] .choice.correct{
  background: color-mix(in oklab, var(--ok) 18%, transparent);
  border-color: var(--ok);
}
:root[data-theme="dark"] .choice.wrong{
  background: color-mix(in oklab, var(--ng) 18%, transparent);
  border-color: var(--ng);
}

/* Progress & dividers */
:root[data-theme="dark"] .wtitle{ color: color-mix(in oklab, var(--on-bg) 88%, transparent); }
:root[data-theme="dark"] .divider{ background:#2C2D33; opacity:1; }


/* ==== Strong overrides for Dark Mode Buttons ==== */
:root[data-theme="dark"] #btnNext{
  background: var(--primary);
  color: #fff;
  border:1px solid color-mix(in oklab, var(--primary) 70%, black);
}
:root[data-theme="dark"] #btnNext:hover{
  background: var(--primary-press);
}

:root[data-theme="dark"] #btnPrev,
:root[data-theme="dark"] #btnSpeak{
  background: #353535;
  color: #E6E7EA;
  border:1px solid #444;
}
:root[data-theme="dark"] #btnPrev:hover,
:root[data-theme="dark"] #btnSpeak:hover{
  background: #404040;
}


/* === Theme-aware hero PNGs (light/dark) === */
.hero-illust{ display:block; max-width:min(560px, 92%); height:auto; margin:12px auto 0; }
.hero-dark{ display:none; }
:root[data-theme="dark"] .hero-light{ display:none; }
:root[data-theme="dark"] .hero-dark{ display:block; }
@media (max-width: 520px){
  .hero-illust{ max-width: min(440px, 92%); margin-top:10px; }
}


/* === Dark theme: button overrides (class-based) === */
:root[data-theme="dark"] .button{
  background:#353535 !important;
  color:var(--on-bg, #E6E7EA) !important;
  border:1px solid #444 !important;
}
:root[data-theme="dark"] .button:not(.next):hover{
  background:#404040 !important;
}
:root[data-theme="dark"] .button.next{
  /* 다음문제로: 보라 톤 */
  background:var(--primary, #A78BFA) !important;
  color:#fff !important;
  border:1px solid color-mix(in oklab, var(--primary, #A78BFA) 70%, black) !important;
}
:root[data-theme="dark"] .button.next:hover{
  background:var(--primary-press, #8B5CF6) !important;
}
/* 비활성(이전) */
:root[data-theme="dark"] .button[disabled]{
  background:#2a2a2a !important;
  color:#8b8b8b !important;
  border-color:#3a3a3a !important;
  opacity:1 !important; /* 기본 흐림 제거 */
}

/* === Main hero illust: 약 70% 크기 === */
/* 데스크톱 기준: 560px → 약 392px (≈70%) */
.hero-illust{
  max-width:min(392px, 70%) !important;
  height:auto !important;
  margin-top:10px !important;
}
/* 모바일 기준: 440px → 약 308px (≈70%) */
@media (max-width:520px){
  .hero-illust{ max-width:min(308px, 72%) !important; }
}


/* === Quiz card image: mobile height reduction === */
/* 모바일 전용: 가로폭이 520px 이하일 때 높이를 축소 */
@media (max-width: 520px) {
  .image {
    height: 260px !important; /* 필요에 따라 240~280px로 조정 가능 */
  }
}

</style>
<link rel="icon" href="asset/favicon.svg">
</head>
<body>
<aside class="sidebar">
  <div class="brand" style="display:flex;align-items:center;justify-content:space-between;gap:12px"><div class="brand-left" style="display:flex;align-items:center;gap:10px"><button class="brand-btn" onclick="App.goHome()" aria-label="홈으로">
  <img id="logo" src="asset/logo-lightmode.png" alt="StudyQuiz 로고" onerror="this.style.display='none'">
</button></div><button id="btnTheme" class="theme-toggle" title="다크 모드 전환" aria-label="다크 모드 전환" aria-pressed="false"></button></div>
  <div id="autoBtnGroup" class="btn-group"></div>
  <input id="fileHtml" type="file" accept=".html,.htm" style="display:none">
<input id="dirPicker" type="file" webkitdirectory directory multiple style="display:none">
<div class="widgets" id="widgets">
  <div class="wcard" aria-live="polite">
  <div id="fileHint" class="wcard" style="display:none">
    <p class="wtitle">로컬 실행 안내</p>
    <div class="wbody">파일로 직접 열었네요. Day 버튼을 누르면 한 번만 <b>studyquiz 폴더 선택</b> 창이 뜹니다. 그 다음부터는 CORS 없이 바로 동작합니다. (또는 간단 서버 실행도 가능)</div>
  </div>

    <p class="wtitle">진행 현황</p>
    <div class="wbody" id="widProgress">퀴즈를 시작하면 표시됩니다.</div>
  </div>
</div>
</aside>

<main class="main"><div id="app"></div></main>

<script>(function(){
function el(id){ return document.getElementById(id); }
  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function basename(p){ p = p||''; var parts = p.split('/'); return parts.length?parts[parts.length-1]:''; }

  // 안전한 store 구현 (?? 없이)
  var store = {
    get: function(k, d){
      try{
        var raw = localStorage.getItem(k);
        if(raw === null || raw === undefined) return d;
        var parsed = JSON.parse(raw);
        if(typeof parsed === 'undefined' || parsed === null) return d;
        return parsed;
      }catch(e){ return d; }
    },
    set: function(k, v){
      try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){}
    }
    
  };

  function pieces(g){
    var a = g.indexOf('（'), b = g.indexOf('）', a+1);
    if(a!==-1 && b!==-1) return [g.slice(0,a).trim(), g.slice(a+1,b).trim()];
    return [g.trim(),''];
  }
  function blankify(jp,g){
    if(!jp||!g) return jp||'';
    if(g.indexOf('〜')>-1){
      var sp = g.split('〜');
      var A = sp[0].trim(), B = sp[1] ? sp[1].trim() : '';
      var iA = jp.indexOf(A);
      if(iA!==-1){
        var iB = jp.indexOf(B, iA + A.length);
        if(iB!==-1) return jp.slice(0,iA) + '____' + jp.slice(iB + B.length);
      }
    }
    var pp = pieces(g);
    var base = pp[0], paren = pp[1];
    var cand = [];
    if(base) cand.push(base.replace(/[ \t]/g,''));
    if(paren) cand.push(paren.replace(/[ \t]/g,''));
    for(var i=0;i<cand.length;i++){
      var c = cand[i];
      if(c && jp.indexOf(c)>-1) return jp.replace(c,'____');
    }
    if(base && jp.indexOf(base)>-1) return jp.replace(base,'____');
    return jp;
  }

  // 최신 문법 없이 파서
  function safeText(node){ return (node && node.textContent) ? node.textContent : ''; }
  function safeAttr(node, name){ return (node && node.getAttribute) ? (node.getAttribute(name) || '') : ''; }

  function parseCustom(doc){
    var blocks = $all('article.q', doc);
    var items = [];
    for(var i=0;i<blocks.length;i++){
      var b = blocks[i];
      var h = $('h3', b);
      var grammar = (safeAttr(h,'data-grammar') || '').trim();
      var meaning = (safeAttr(h,'data-meaning') || '').trim();
      var jp = safeText($('.jp', b)).trim();
      var kr = safeText($('.kr', b)).trim();
      var img = $('.photo', b);
      var alt = safeAttr(img,'alt').trim();
      var src = safeAttr(img,'src').trim();
      var image = alt || basename(src);
      var detail = safeText($('.desc', b)).trim();
      if(grammar && jp && kr){
        items.push({grammar:grammar, explanation:meaning, detail:detail, jp:jp, kr:kr, image:image, originalSrc:src});
      }
    }
    return items;
  }

  function parseNotion(doc){
    var items = [];
    var callouts = $all('figure.callout', doc);
    for(var i=0;i<callouts.length;i++){
      var fig = callouts[i];
      var h3 = $('h3', fig);
      var head = (safeText(h3) || '').trim().replace(/\s+/g,' ');
      if(!head) continue;
      var pos = head.indexOf(' : '); if(pos<0) pos = head.indexOf(':');
      if(pos<0) continue;
      var grammar = head.slice(0,pos).trim();
      var meaning = head.slice(pos+1).trim();
      var boundary = (i+1<callouts.length) ? callouts[i+1] : null;
      var node = fig.nextElementSibling;
      var jp='', kr='', image='', originalSrc='';
      var steps=0;
      while(node && node!==boundary && steps<200){
        if(node.tagName==='P'){
          var html = node.innerHTML.replace(/<br\s*\/?>(?=\n?)/gi, '\n');
          var tmp = new DOMParser().parseFromString('<div>'+html+'</div>','text/html');
          var text = tmp.documentElement.textContent || '';
          var mJP = text.match(/JP\s*[：:]\s*(.+)/);
          var mKR = text.match(/KR\s*[：:]\s*(.+)/);
          if(mJP && !jp) jp = mJP[1].trim();
          if(mKR && !kr) kr = mKR[1].trim();
          if(!image){
            var imgInP = $('img', node);
            if(imgInP){
              originalSrc = safeAttr(imgInP,'src').trim();
              image = basename(originalSrc);
            }
          }
        } else if(node.tagName==='FIGURE' && !node.classList.contains('callout')){
          if(!image){
            var im = $('img', node);
            if(im){
              originalSrc = safeAttr(im,'src').trim();
              image = basename(originalSrc);
            }
          }
        }
        node = node.nextElementSibling;
        steps++;
      }
      if(grammar && jp && kr){
        items.push({grammar:grammar, explanation:meaning, detail:'', jp:jp, kr:kr, image:image, originalSrc:originalSrc});
      }
    }
    // dedup
    var dedup = [], seen = {};
    for(var j=0;j<items.length;j++){
      var it = items[j];
      var key = it.grammar + '|' + it.jp;
      if(!seen[key]){ dedup.push(it); seen[key]=true; }
    }
    return dedup;
  }

  function buildOptions(items){
    var grams = items.map(function(it){ return it.grammar; });
    items.forEach(function(it){
      it.answer = it.grammar;
      var pool = grams.filter(function(g){ return g!==it.grammar; });
      for(var i=pool.length-1;i>0;i--){
        var r = Math.floor(Math.random()*(i+1));
        var t = pool[i]; pool[i] = pool[r]; pool[r] = t;
      }
      var opts = pool.slice(0,3);
      while(opts.length<3) opts.push(it.grammar);
      var arr = opts.concat([it.answer]);
      arr.sort(function(){ return Math.random()-0.5; });
      it.options = arr;
    });
    return items;
  }

  var st = { data:[], idx:0, right:0, done:0, answered:{} };

  function updateWidgets(){
    var elP = document.getElementById('widProgress');
    var total = st.data ? st.data.length : 0;
    if(elP){
      if(total>0){
        var wrong = (st.done - st.right);
        if(wrong < 0) wrong = 0;
        var rate = total ? Math.round(((total - wrong) / total) * 100) : 100; // 100%에서 시작, 오답마다 감소
        if(rate < 0) rate = 0;
        if(rate > 100) rate = 100;
        elP.textContent = '✅ ' + st.right + ' / ' + total + ' 문제 · 정답률 ' + rate + '%';
      }else{
        elP.textContent = '퀴즈를 시작하면 표시됩니다.';
      }
    }
}


  function goHome(){
    // reset in-memory state and UI
    st.data = [];
    st.idx = 0;
    var inp = el('fileHtml'); if(inp) try{ inp.value = ''; }catch(e){}
    st.right=0; st.done=0; st.answered={};
    renderIntro();
    updateWidgets();
  }


  function renderIntro(){
    el('app').innerHTML = [
  '<div class="card intro">',
  '  <picture id="heroImages"><img class="hero-illust hero-light" src="asset/main_illust_lightmode.png" alt="학습 일러스트(라이트 모드)"><img class="hero-illust hero-dark" src="asset/main_illust_darkmode.png" alt="학습 일러스트(다크 모드)"></picture>',
  '  <h2 class="title">일본어 문법 퀴즈</h2>',
  '  <p class="subtitle">공부했던 내용을 복습해봅시다.</p>',
  '</div>'
].join('');
updateWidgets();
}

  function render(){
    if(!st || !st.data || st.data.length===0){ renderIntro(); updateWidgets(); return; }
if(!st.data.length){ st.right=0; st.done=0; st.answered={};
    renderIntro();
    updateWidgets(); return; }
    var q = st.data[st.idx];
    var jpBlank = blankify(q.jp, q.grammar);
    var computed = 'photocard/' + (q.image||'');
    var original = q.originalSrc || '';
    var prevDis = (st.idx===0 ? 'disabled' : '');

    var optionsHTML = q.options.map(function(o){
      return '<button class="choice" onclick="App.pick(this,\'' + o.replace(/'/g, "\\'") + '\')">' + o + '</button>';
    }).join('');

    el('app').innerHTML = ''
      + '<div class="card" role="group" aria-label="퀴즈 카드">'
      + '  <div class="header">'
      + '    <h3 style="margin:0">문제 ' + (st.idx+1) + '</h3>'
      + '    <div class="progress">' + (st.idx+1) + '/' + st.data.length + '</div>'
      + '  </div>'
      + '  <img class="image" src="' + computed + '" title="' + (q.image||'') + '"'
      + '       onerror="this.style.display=\'none\';const h=this.nextElementSibling;h.style.display=\'block\'; if(\'' + original + '\'){ const img=new Image(); img.onload=()=>{this.style.display=\'\'; this.src=\'' + original + '\'; h.style.display=\'none\';}; img.src=\'' + original + '\'; }">'
      + '  <div class="img-hint">이미지를 불러올 수 없습니다. 확인 경로: <code>' + computed + '</code>' + (original?(' → 폴백시도: <code>' + original + '</code>'):'') + '</div>'
      + '  <p class="jp">' + jpBlank + '</p>'
      + '  <p class="kr">' + q.kr + '</p>'
      + '  <div class="grid">' + optionsHTML + '</div>'
      + '  <div class="controls">'
      + '    <button class="button" ' + prevDis + ' onclick="App.prev()">이전</button>'
      + '    <button class="button" onclick="App.speak(\'' + q.jp.replace(/'/g, "\\'") + '\')">🔊 듣기</button>'
      + '    <button class="button next" onclick="App.next()">다음문제로</button>'
      + '  </div>'
      + '  <div class="divider"></div>'
      + '  <div id="feedback" class="feedback"></div>' + '</div>';}

  function pick(btn, val){
    var q = st.data[st.idx];
    var all = $all('.choice');
    all.forEach(function(b){ b.disabled = true; });
    if(!st.answered[st.idx]){ st.done++; st.answered[st.idx]=true; }
    var fb = document.getElementById('feedback');
    if(val===q.answer){
      btn.classList.add('correct');
      st.right++;
      if(fb){
        fb.innerHTML = ''
          + '<div class="fb-head ok">' + '✅ 정답입니다!' + '</div>'
          + '<div class="fb-body">' + (q.explanation||'') + '</div>';
      }
    } else {
      btn.classList.add('wrong');
      var right = null;
      for(var i=0;i<all.length;i++){ if(all[i].textContent===q.answer){ right = all[i]; break; } }
      if(right) right.classList.add('correct');
      if(fb){
        fb.innerHTML = ''
          + '<div class="fb-head ng">' + '❌ 틀렸습니다.' + '</div>'
          + '<div class="fb-body">' + (q.explanation||'') + '</div>';
      }
    }
    updateWidgets();
  }

  function next(){
    if(st.idx < st.data.length-1){ st.idx++; render(); updateWidgets(); }
    else{
      el('app').innerHTML = ''
        + '<div class="card intro complete">'
        + '  <picture id="heroImages"><img class="hero-illust hero-light" src="asset/main_illust_lightmode.png" alt="학습 일러스트(라이트 모드)"><img class="hero-illust hero-dark" src="asset/main_illust_darkmode.png" alt="학습 일러스트(다크 모드)"></picture>'
        + '  <h2 class="title">퀴즈 완료 🎉</h2>'
        + '  <p class="subtitle">다시 풀기를 누르면 1번부터 시작합니다.</p>'
        + '  <div class="controls" style="margin-top:16px">'
        + '    <button class="button next" onclick="App.restart()">다시 풀기</button>'
        + '  </div>'
        + '</div>';
    }
    updateWidgets();
  }
  function prev(){ if(st.idx>0){ st.idx--; render(); } }
  function restart(){ st.idx=0; st.right=0; st.done=0; st.answered={}; render(); updateWidgets(); }
  function speak(t){
    try{
      var u = new SpeechSynthesisUtterance(t);
      u.lang = 'ja-JP';
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(e){}
    updateWidgets();
  }

  function pickHTML(){
    var inp = el('fileHtml');
    inp.onchange = function(e){
      var f = e.target.files[0]; if(!f) return;
      var r = new FileReader();
      r.onload = function(ev){
        var html = ev.target.result;
        var doc = new DOMParser().parseFromString(html,'text/html');
        var items = parseCustom(doc);
        if(!items.length){ items = parseNotion(doc); }
        items = buildOptions(items);
        st.data = items;
        st.idx = 0; st.right=0; st.done=0; st.answered={};
        render();
        updateWidgets();
        if(!st.data.length){
          el('app').innerHTML = '<div class="card"><h3>jp.html에서 문제를 찾지 못했어요 😢</h3><p class="kr">Notion 내보내기 형태라면 <b>figure.callout</b> 아래 ~ 다음 callout 전까지에 <b>JP :</b> / <b>KR :</b> 라인이 필요합니다. 이미지가 있으면 더 좋아요.</p></div>';
        }
      };
      r.readAsText(f,'utf-8');
    };
    inp.click();
  }

  
  // 고정 세트 로드 (same-origin) : quizdata/*.html
  
  // --- CORS-safe local fallback ---
  // When opened via file://, fetch() is blocked in Chrome.
  // We allow user to pick the "studyquiz" folder once, then read quizdata/*.html via FileReader.
  var DirCache = { files: {}, ready: false };
  function ensureFolderAccess(cb){
    if(DirCache.ready){ cb(); return; }
    var input = document.getElementById('dirPicker');
    if(!input){ cb(); return; }
    input.onchange = function(e){
      DirCache.files = {};
      var list = e.target.files;
      for(var i=0;i<list.length;i++){
        var f = list[i];
        // normalize relative path key (remove leading folder name)
        var rel = (f.webkitRelativePath || f.name).replace(/^.*?studyquiz[\\/]/,'');
        DirCache.files[rel] = f;
      }
      DirCache.ready = true;
      cb();
    };
    input.click();
  }
  function readLocal(relPath){
    return new Promise(function(resolve, reject){
      var f = DirCache.files[relPath] || DirCache.files['quizdata/' + relPath] || DirCache.files[relPath.replace(/^\.\//,'')];
      if(!f){ return reject(new Error('선택한 폴더에서 '+relPath+'를 찾지 못했습니다.')); }
      var r = new FileReader();
      r.onload = function(ev){ resolve(String(ev.target.result||'')); };
      r.onerror = function(){ reject(new Error('파일 읽기 실패: '+relPath)); };
      r.readAsText(f, 'utf-8');
    });
  }
function loadSet(url){
    var useFetch = location.protocol === 'http:' || location.protocol === 'https:';
    if(!useFetch){
      ensureFolderAccess(function(){
        readLocal(url).then(function(html){
          var doc = new DOMParser().parseFromString(html,'text/html');
          var items = parseCustom(doc); if(!items.length) items = parseNotion(doc);
          items = buildOptions(items);
          st.data = items; st.idx=0; st.right=0; st.done=0; st.answered={};
          render(); updateWidgets();
          if(!st.data.length){
            el('app').innerHTML = [
              '<div class="card intro">',
              '  <h2 class="title">파일에서 문항을 찾지 못했습니다</h2>',
              '  <p class="subtitle">Quiz_Day*.html 구조를 알려주시면 파서를 보강할게요.</p>',
              '</div>'
            ].join('');
            updateWidgets();
          }
        }).catch(function(err){
          console.error(err); alert(err.message||err);
        });
      });
      return; // stop here for file://
    }

    fetch(url, { cache: 'no-cache' })
      .then(function(res){
        if(!res.ok) throw new Error('HTTP ' + res.status);
        return res.text();
      })
      .then(function(html){
        var doc = new DOMParser().parseFromString(html,'text/html');
        var items = parseCustom(doc);
        if(!items.length){ items = parseNotion(doc); }
        items = buildOptions(items);
        st.data = items;
        st.idx = 0; st.right=0; st.done=0; st.answered={};
        render();
        updateWidgets();
        if(!st.data.length){
          el('app').innerHTML = [
  '<div class="card intro">',
  '  <picture id="heroImages"><img class="hero-illust hero-light" src="asset/main_illust_lightmode.png" alt="학습 일러스트(라이트 모드)"><img class="hero-illust hero-dark" src="asset/main_illust_darkmode.png" alt="학습 일러스트(다크 모드)"></picture>',
  '  <h2 class="title">일본어 문법 퀴즈</h2>',
  '  <p class="subtitle">공부했던 내용을 복습해봅시다.</p>',
  '</div>'
].join('');
updateWidgets();
}
      })
      .catch(function(err){
        console.error(err);
        alert('로드 실패: ' + (err && err.message ? err.message : err));
      });
  }

  // ---- Dynamic discovery of quizdata/Quiz_Day*.html ----
  function extractDayNum(name){
    var m = name.match(/Quiz_Day(\d+)\.html$/i);
    return m ? parseInt(m[1], 10) : 0;
  }
  function renderDayButtons(files){
    var box = document.getElementById('autoBtnGroup');
    if(!box) return;
    box.innerHTML = '';
    if(!files || !files.length){
      box.innerHTML = '<small>quizdata/ 폴더에서 Quiz_Day*.html을 찾지 못했습니다.</small>';
      return;
    }
    files.sort(function(a,b){ return extractDayNum(a) - extractDayNum(b); });
    files.forEach(function(file){
      var n = extractDayNum(file);
      var btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = 'Day' + (n||'');
      btn.onclick = function(){ App.loadSet('quizdata/' + file); };
      box.appendChild(btn);
    });
  }
  function discoverDaysHTTP(){
    // 1) Try manifest
    return fetch('quizdata/index.json', {cache:'no-cache'})
      .then(function(r){ if(!r.ok) throw new Error('no manifest'); return r.json(); })
      .then(function(arr){
        var files = (arr||[]).filter(function(x){ return /Quiz_Day\d+\.html$/i.test(x); });
        renderDayButtons(files);
      })
      .catch(function(){
        // 2) Probe sequentially with HEAD, stop after several misses
        var found = [];
        var i = 1, limit = 365, misses = 0, maxMiss = 5;
        function step(){
          if(i>limit || misses>=maxMiss){ renderDayButtons(found); return; }
          var name = 'Quiz_Day' + i + '.html';
          fetch('quizdata/' + name, { method:'HEAD', cache:'no-cache' })
            .then(function(r){ if(r.ok){ found.push(name); misses=0; } else { misses++; } i++; step(); })
            .catch(function(){ misses++; i++; step(); });
        }
        step();
      });
  }
  function discoverDaysFILE(){
    ensureFolderAccess(function(){
      var keys = Object.keys(DirCache.files);
      var files = keys
        .filter(function(k){ return /(^|\/)quizdata\/Quiz_Day\d+\.html$/i.test(k); })
        .map(function(k){ return k.replace(/^.*?quizdata[\\/]/,''); });
      renderDayButtons(files);
    });
  }
  function discoverDays(){
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', discoverDays);
      return;
    }
    if(location.protocol === 'file:'){ discoverDaysFILE(); }
    else { discoverDaysHTTP(); }
  }
  // Run once
  discoverDays();

  // ===== Theme toggle (light <-> dark, persisted) =====
(function(){
  var KEY = 'sq:theme';
  function apply(th){
    var mode = (th === 'dark') ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', mode);
    try{ localStorage.setItem(KEY, mode); }catch(e){}
    var btn = document.getElementById('btnTheme');
    if(btn){
      var isDark = (mode === 'dark');
      btn.setAttribute('aria-pressed', isDark ? 'true' : 'false');
      btn.title = isDark ? '라이트 모드로' : '다크 모드로';
    }
    var logo = document.getElementById('logo');
    if(logo){
      logo.src = (mode === 'dark') ? 'asset/logo-nightmode.png' : 'asset/logo-lightmode.png';
    }
  }
  var saved = null; try{ saved = localStorage.getItem(KEY); }catch(e){}
  if(!saved){ saved = 'light'; }
  apply(saved);
  var btn = document.getElementById('btnTheme');
  if(btn){
    btn.addEventListener('click', function(){
      var cur = (localStorage.getItem(KEY) || 'light');
      apply(cur === 'light' ? 'dark' : 'light');
    });
  }
})();

// ===== Expose App globally =====
window.App = {
  pickHTML: pickHTML,
  loadSet: loadSet,
  pick: pick,
  next: next,
  prev: prev,
  restart: restart,
  speak: speak,
  goHome: goHome
};
})();

// --- Bootstrap: show intro on first visit when no data loaded ---
(function(){
  function bootIntro(){
    try{
      if(!window.st || !st.data || st.data.length===0){
        if(typeof renderIntro==='function'){ renderIntro(); }
        if(typeof updateWidgets==='function'){ updateWidgets(); }
      }
    }catch(e){ console.warn(e); }
  }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', bootIntro);
  }else{
    bootIntro();
  }
})();

</script>
</body>
</html>